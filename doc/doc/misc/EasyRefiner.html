<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of EasyRefiner</title>
  <meta name="keywords" content="EasyRefiner">
  <meta name="description" content="EASYREFINER a simple GUI interface for refining EasySpin simulations">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">doc</a> &gt; <a href="index.html">misc</a> &gt; EasyRefiner.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for doc/misc&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>EasyRefiner
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>EASYREFINER a simple GUI interface for refining EasySpin simulations</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function varargout = EasyRefiner(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> EASYREFINER a simple GUI interface for refining EasySpin simulations

   EASYREFINER takes a file or folders of files and queues them for
       fitting with EasySpin (easyspin.org).

       Furthermore it allows for rough initial parameters to be used and
       the best fit results to be put back into EasySpin with finer search
       parameters to get the best possible fit.

       Results are automatically calculated, saved, logged and formatted
       for easy plotting.

 Syntax:  EASYREFINER

 Inputs:
    input1     - Files
                   selectable using &quot;Load file&quot; and &quot;Load folder&quot;
    input2     - System
                   System properties for EasySpin. Anything can be used,
                   but it is recommend to use &quot;Sys.Variable&quot;
    input3     - Experiment
                   Experiment properties for EasySpin. You must use
                   &quot;Exp.Variable&quot; as the experiment frequency and magnetic
                   field range are imported automatically from the file
    input4,5,6 - Variables
                   Variable properties for EasySpin. Anything can be used,
                   but it is recommend to use &quot;Var.Variable&quot;
    input7     - Fitting options
                   Fitting properties for EasySpin. You must use
                   &quot;FitOpt.Variable&quot; or &quot;SimOpt.Variable&quot; here

 Outputs:
    output1    - Command window
                   EasySpin results are printed out
    output2    - EasyRefiner_Results (structure)
                   Fitting results
    output2    - Figures
                   EasySpin fitting figures
    output3    - DD-MM-YY_hh:mm_EasyRefiner_Log.txt
                   Log file from fitting
    output4    - DD-MM-YY_hh:mm_EasyRefiner_Results.mat
                   Matlab array of fitting results

 Example: 
    see http://morganbye.net/eprtoolbox/easyrefiner

 Other m-files required:   BrukerRead

 Subfunctions:             n/a

 MAT-files required:       none

 To-do list:               


 See also: EASYSPIN <a href="BrukerRead.html" class="code" title="function varargout = BrukerRead(varargin)">BRUKERREAD</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="BrukerRead.html" class="code" title="function varargout = BrukerRead(varargin)">BrukerRead</a>	BRUKERREAD Open Bruker BE3ST files (.DTA / .DSC , .spc / .par) into the</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function EasyRefiner_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub2" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub3" class="code">function varargout = EasyRefiner_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub4" class="code">function button_loadFile_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub5" class="code">function button_loadFolder_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub6" class="code">function listbox_files_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub7" class="code">function listbox_files_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub8" class="code">function edit_system_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub9" class="code">function edit_system_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub10" class="code">function popupmenu_defaults_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function popupmenu_defaults_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub12" class="code">function button_systemLoad_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub13" class="code">function edit_exp_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub14" class="code">function edit_exp_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub15" class="code">function button_expHelp_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub16" class="code">function button_output_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub17" class="code">function edit_outputAddress_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub18" class="code">function edit_outputAddress_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub19" class="code">function checkbox_figureOpen_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub20" class="code">function checkbox_figureSave_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub21" class="code">function checkbox_delay_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub22" class="code">function checkbox_log_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub23" class="code">function edit_delay_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub24" class="code">function edit_delay_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub25" class="code">function popupmenu_esFitting_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub26" class="code">function popupmenu_esFitting_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub27" class="code">function popupmenu_esFitMethod_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub28" class="code">function popupmenu_esFitMethod_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub29" class="code">function edit_opt_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub30" class="code">function edit_opt_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub31" class="code">function edit_var1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub32" class="code">function edit_var1_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub33" class="code">function checkbox_var1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub34" class="code">function edit_var2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub35" class="code">function edit_var2_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub36" class="code">function checkbox_var2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub37" class="code">function edit_var3_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub38" class="code">function edit_var3_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub39" class="code">function checkbox_var3_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub40" class="code">function edit_info_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub41" class="code">function edit_info_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub42" class="code">function defaultSelection(hObject, eventdata, handles)</a></li><li><a href="#_sub43" class="code">function button_RUN_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub44" class="code">function button_RunLater_Callback(hObject, eventdata, handles)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = EasyRefiner(varargin)</a>
0002 
0003 <span class="comment">% EASYREFINER a simple GUI interface for refining EasySpin simulations</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   EASYREFINER takes a file or folders of files and queues them for</span>
0006 <span class="comment">%       fitting with EasySpin (easyspin.org).</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%       Furthermore it allows for rough initial parameters to be used and</span>
0009 <span class="comment">%       the best fit results to be put back into EasySpin with finer search</span>
0010 <span class="comment">%       parameters to get the best possible fit.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%       Results are automatically calculated, saved, logged and formatted</span>
0013 <span class="comment">%       for easy plotting.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Syntax:  EASYREFINER</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Inputs:</span>
0018 <span class="comment">%    input1     - Files</span>
0019 <span class="comment">%                   selectable using &quot;Load file&quot; and &quot;Load folder&quot;</span>
0020 <span class="comment">%    input2     - System</span>
0021 <span class="comment">%                   System properties for EasySpin. Anything can be used,</span>
0022 <span class="comment">%                   but it is recommend to use &quot;Sys.Variable&quot;</span>
0023 <span class="comment">%    input3     - Experiment</span>
0024 <span class="comment">%                   Experiment properties for EasySpin. You must use</span>
0025 <span class="comment">%                   &quot;Exp.Variable&quot; as the experiment frequency and magnetic</span>
0026 <span class="comment">%                   field range are imported automatically from the file</span>
0027 <span class="comment">%    input4,5,6 - Variables</span>
0028 <span class="comment">%                   Variable properties for EasySpin. Anything can be used,</span>
0029 <span class="comment">%                   but it is recommend to use &quot;Var.Variable&quot;</span>
0030 <span class="comment">%    input7     - Fitting options</span>
0031 <span class="comment">%                   Fitting properties for EasySpin. You must use</span>
0032 <span class="comment">%                   &quot;FitOpt.Variable&quot; or &quot;SimOpt.Variable&quot; here</span>
0033 <span class="comment">%</span>
0034 <span class="comment">% Outputs:</span>
0035 <span class="comment">%    output1    - Command window</span>
0036 <span class="comment">%                   EasySpin results are printed out</span>
0037 <span class="comment">%    output2    - EasyRefiner_Results (structure)</span>
0038 <span class="comment">%                   Fitting results</span>
0039 <span class="comment">%    output2    - Figures</span>
0040 <span class="comment">%                   EasySpin fitting figures</span>
0041 <span class="comment">%    output3    - DD-MM-YY_hh:mm_EasyRefiner_Log.txt</span>
0042 <span class="comment">%                   Log file from fitting</span>
0043 <span class="comment">%    output4    - DD-MM-YY_hh:mm_EasyRefiner_Results.mat</span>
0044 <span class="comment">%                   Matlab array of fitting results</span>
0045 <span class="comment">%</span>
0046 <span class="comment">% Example:</span>
0047 <span class="comment">%    see http://morganbye.net/eprtoolbox/easyrefiner</span>
0048 <span class="comment">%</span>
0049 <span class="comment">% Other m-files required:   BrukerRead</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% Subfunctions:             n/a</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% MAT-files required:       none</span>
0054 <span class="comment">%</span>
0055 <span class="comment">% To-do list:</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% See also: EASYSPIN BRUKERREAD</span>
0059 
0060 <span class="comment">%                                        _                             _</span>
0061 <span class="comment">%                                       | |                           | |</span>
0062 <span class="comment">%  _ __ ___   ___  _ __ __ _  __ _ _ __ | |__  _   _  ___   _ __   ___| |_</span>
0063 <span class="comment">% | '_ ` _ \ / _ \| '__/ _` |/ _` | '_ \| '_ \| | | |/ _ \ | '_ \ / _ \ __|</span>
0064 <span class="comment">% | | | | | | (_) | | | (_| | (_| | | | | |_) | |_| |  __/_| | | |  __/ |_</span>
0065 <span class="comment">% |_| |_| |_|\___/|_|  \__, |\__,_|_| |_|_.__/ \__, |\___(_)_| |_|\___|\__|</span>
0066 <span class="comment">%                       __/ |                   __/ |</span>
0067 <span class="comment">%                      |___/                   |___/</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%</span>
0070 <span class="comment">% M. Bye v13.03</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% Author:       Morgan Bye</span>
0073 <span class="comment">% Work address: Henry Wellcome Unit for Biological EPR</span>
0074 <span class="comment">%               University of East Anglia</span>
0075 <span class="comment">%               NORWICH, UK</span>
0076 <span class="comment">% Email:        morgan.bye@uea.ac.uk</span>
0077 <span class="comment">% Website:      http://www.morganbye.net/eprtoolbox/cwviewer</span>
0078 <span class="comment">% Mar 2013;     Last revision: 14-March-2013</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% Approximate coding time of file:</span>
0081 <span class="comment">%               20 hours</span>
0082 <span class="comment">%</span>
0083 <span class="comment">%</span>
0084 <span class="comment">% Version history:</span>
0085 <span class="comment">% Mar 13        &quot;Run later&quot; button added</span>
0086 <span class="comment">%               Better error handling</span>
0087 <span class="comment">%               Supports long file names</span>
0088 <span class="comment">%               Closing waitbar cancels queue</span>
0089 <span class="comment">%               Seperating of fitting in command window using file name</span>
0090 <span class="comment">%               Add fit results to the output</span>
0091 <span class="comment">%               Handling of non-valid file name characters in file title</span>
0092 <span class="comment">%</span>
0093 <span class="comment">% Feb 13        Initial release</span>
0094 
0095 <span class="comment">% Edit the above text to modify the response to help EasyRefiner</span>
0096 
0097 <span class="comment">% Last Modified by GUIDE v2.5 12-Feb-2013 16:04:27</span>
0098 
0099 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0100 gui_Singleton = 1;
0101 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0102                    <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0103                    <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub1" class="code" title="subfunction EasyRefiner_OpeningFcn(hObject, eventdata, handles, varargin)">EasyRefiner_OpeningFcn</a>, <span class="keyword">...</span>
0104                    <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub3" class="code" title="subfunction varargout = EasyRefiner_OutputFcn(hObject, eventdata, handles)">EasyRefiner_OutputFcn</a>, <span class="keyword">...</span>
0105                    <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0106                    <span class="string">'gui_Callback'</span>,   []);
0107 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0108     gui_State.gui_Callback = str2func(varargin{1});
0109 <span class="keyword">end</span>
0110 
0111 <span class="keyword">if</span> nargout
0112     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0113 <span class="keyword">else</span>
0114     gui_mainfcn(gui_State, varargin{:});
0115 <span class="keyword">end</span>
0116 <span class="comment">% End initialization code - DO NOT EDIT</span>
0117 
0118 
0119 <span class="comment">% --- Executes just before EasyRefiner is made visible.</span>
0120 <a name="_sub1" href="#_subfunctions" class="code">function EasyRefiner_OpeningFcn(hObject, eventdata, handles, varargin)</a>
0121 <span class="comment">% This function has no output args, see OutputFcn.</span>
0122 <span class="comment">% hObject    handle to figure</span>
0123 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0124 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0125 <span class="comment">% varargin   command line arguments to EasyRefiner (see VARARGIN)</span>
0126 
0127 <span class="comment">% Choose default command line output for EasyRefiner</span>
0128 handles.output = hObject;
0129 
0130 <span class="comment">% Update handles structure</span>
0131 guidata(hObject, handles);
0132 
0133 <span class="comment">% Name the window</span>
0134 set(gcf,<span class="string">'Name'</span>,<span class="string">'EasyRefiner - v13.03'</span>);
0135 
0136 <span class="comment">% Update output location edit box to current folder</span>
0137 set(handles.edit_outputAddress,<span class="string">'String'</span>,pwd);
0138 set(handles.edit_outputAddress,<span class="string">'Tooltipstring'</span>,pwd);
0139 
0140 <span class="comment">% Set edit boxes to accept multiline input</span>
0141 set(handles.edit_system,<span class="string">'Max'</span>,2);
0142 set(handles.edit_exp ,<span class="string">'Max'</span>,2);
0143 set(handles.edit_opt ,<span class="string">'Max'</span>,2);
0144 set(handles.edit_var1,<span class="string">'Max'</span>,2);
0145 set(handles.edit_var2,<span class="string">'Max'</span>,2);
0146 set(handles.edit_var3,<span class="string">'Max'</span>,2);
0147 set(handles.edit_info,<span class="string">'Max'</span>,2);
0148 
0149 <span class="comment">% Create global variable</span>
0150 <span class="keyword">global</span> ER;
0151 
0152 <span class="comment">% --- Executes when user attempts to close figure1.</span>
0153 <a name="_sub2" href="#_subfunctions" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles)</a>
0154 
0155 <span class="comment">% Hint: delete(hObject) closes the figure</span>
0156 delete(hObject);
0157 
0158 <span class="comment">% Clear global variable, else files wont clear if ER is reopened</span>
0159 clear <span class="keyword">global</span> ER
0160 
0161 
0162 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0163 <a name="_sub3" href="#_subfunctions" class="code">function varargout = EasyRefiner_OutputFcn(hObject, eventdata, handles) </a>
0164 <span class="comment">% varargout  cell array for returning output args (see VARARGOUT);</span>
0165 <span class="comment">% hObject    handle to figure</span>
0166 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0167 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0168 
0169 <span class="comment">% Get default command line output from handles structure</span>
0170 varargout{1} = handles.output;
0171 
0172 <span class="comment">% oooooooooooo  o8o  oooo</span>
0173 <span class="comment">% `888'     `8  `&quot;'  `888</span>
0174 <span class="comment">%  888         oooo   888   .ooooo.   .oooo.o</span>
0175 <span class="comment">%  888oooo8    `888   888  d88' `88b d88(  &quot;8</span>
0176 <span class="comment">%  888    &quot;     888   888  888ooo888 `&quot;Y88b.</span>
0177 <span class="comment">%  888          888   888  888    .o o.  )88b</span>
0178 <span class="comment">% o888o        o888o o888o `Y8bod8P' 8&quot;&quot;888P'</span>
0179 
0180 
0181 <span class="comment">% --- Executes on button press in button_loadFile.</span>
0182 <a name="_sub4" href="#_subfunctions" class="code">function button_loadFile_Callback(hObject, eventdata, handles)</a>
0183 
0184 <span class="keyword">global</span> ER
0185 
0186 <span class="keyword">try</span>
0187     ER.fileNum = size(fieldnames(ER.data),1) +1;
0188 <span class="keyword">catch</span>
0189     ER.fileNum = 1;
0190 <span class="keyword">end</span>
0191 
0192 <span class="comment">% Load the file</span>
0193 [x , y , info] = <a href="BrukerRead.html" class="code" title="function varargout = BrukerRead(varargin)">BrukerRead</a>;
0194 
0195 <span class="comment">% Move the file to data structure</span>
0196 ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).x = x;
0197 ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).y = y;
0198 ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).info = info;
0199 
0200 <span class="comment">% Get string in File Details window listbox</span>
0201 files = get(handles.listbox_files,<span class="string">'String'</span>);
0202 
0203 <span class="comment">% See if files have been listed previously</span>
0204 <span class="keyword">if</span> strcmp(files , <span class="string">'-- No file loaded --'</span>)
0205     files = [<span class="string">'1: '</span> , regexprep(info.TITL , <span class="string">''''</span>,<span class="string">''</span>)];
0206     files = sscanf(files,<span class="string">'%c'</span>,25);      <span class="comment">% Cuts down to 25 characters</span>
0207     files = sprintf(<span class="string">'%-25s'</span>,files);     <span class="comment">% Makes up to 25 characters</span>
0208     
0209     <span class="comment">% Write out new string to File Details listbox</span>
0210     set(handles.listbox_files,<span class="string">'String'</span>,files)
0211     
0212     <span class="comment">% Change focus of listbox to the new file</span>
0213     set(handles.listbox_files,<span class="string">'Value'</span>, 1)
0214 
0215 <span class="comment">% If previous file then get string, add new string title to a new line</span>
0216 <span class="keyword">else</span>
0217     Num = mat2str(ER.fileNum);
0218     next_line = [Num , <span class="string">': '</span> , regexprep(info.TITL , <span class="string">''''</span>,<span class="string">''</span>)];
0219     next_formated = sscanf(next_line,<span class="string">'%c'</span>,25);
0220     next_formated = sprintf(<span class="string">'%-25s'</span>,next_formated);
0221     files = [files ; next_formated];
0222     
0223     <span class="comment">% Write out new string to File Details listbox</span>
0224     set(handles.listbox_files,<span class="string">'String'</span>,files)
0225     
0226     <span class="comment">% Change focus of listbox to the new file</span>
0227     set(handles.listbox_files,<span class="string">'Value'</span>, str2num(Num));
0228 
0229 <span class="keyword">end</span>
0230 
0231 ER.files = files;
0232 
0233 
0234 <span class="comment">% --- Executes on button press in button_loadFolder.</span>
0235 <a name="_sub5" href="#_subfunctions" class="code">function button_loadFolder_Callback(hObject, eventdata, handles)</a>
0236 
0237 <span class="keyword">global</span> ER
0238 
0239 <span class="comment">% Find all the spectra</span>
0240 folder = uigetdir;
0241 dtaFiles = dir([folder <span class="string">'/*.DTA'</span>]);
0242 
0243 <span class="keyword">if</span> numel(dtaFiles) ~= 0
0244     <span class="keyword">for</span> k=1:numel(dtaFiles)
0245                 
0246         <span class="comment">% Set file number for file</span>
0247         <span class="keyword">try</span>
0248             ER.fileNum = size(fieldnames(ER.data),1) +1;
0249         <span class="keyword">catch</span>
0250             ER.fileNum = 1;
0251         <span class="keyword">end</span>
0252         
0253         <span class="comment">% Load the file</span>
0254         [x , y , info] = <a href="BrukerRead.html" class="code" title="function varargout = BrukerRead(varargin)">BrukerRead</a>([folder <span class="string">'/'</span> dtaFiles(k).name]);
0255         
0256         <span class="comment">% Move the file to data structure</span>
0257         ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).x = x;
0258         ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).y = y;
0259         ER.data.([<span class="string">'File'</span> mat2str(ER.fileNum)]).info = info;
0260         
0261         <span class="comment">% Get string in File Details window listbox</span>
0262         files = get(handles.listbox_files,<span class="string">'String'</span>);
0263         
0264         <span class="comment">% See if files have been listed previously</span>
0265         <span class="keyword">if</span> strcmp(files , <span class="string">'-- No file loaded --'</span>)
0266             files = [<span class="string">'1: '</span> , regexprep(info.TITL , <span class="string">''''</span>,<span class="string">''</span>)];
0267             files = sscanf(files,<span class="string">'%c'</span>,25);      <span class="comment">% Cuts down to 25 characters</span>
0268             files = sprintf(<span class="string">'%-25s'</span>,files);     <span class="comment">% Makes up to 25 characters</span>
0269             
0270             <span class="comment">% Write out new string to File Details listbox</span>
0271             set(handles.listbox_files,<span class="string">'String'</span>,files)
0272             
0273             <span class="comment">% If previous file then get string, add new string title to a new line</span>
0274         <span class="keyword">else</span>
0275             Num = mat2str(ER.fileNum);
0276             next_line = [Num , <span class="string">': '</span> , regexprep(info.TITL , <span class="string">''''</span>,<span class="string">''</span>)];
0277             next_formated = sscanf(next_line,<span class="string">'%c'</span>,25);
0278             next_formated = sprintf(<span class="string">'%-25s'</span>,next_formated);
0279             files = [files ; next_formated];
0280             
0281             <span class="comment">% Write out new string to File Details listbox</span>
0282             set(handles.listbox_files,<span class="string">'String'</span>,files)
0283                         
0284         <span class="keyword">end</span>
0285     <span class="keyword">end</span>
0286     
0287     <span class="comment">% Change focus of listbox to the new file</span>
0288     set(handles.listbox_files,<span class="string">'Value'</span>, ER.fileNum);
0289     
0290 <span class="keyword">else</span>
0291     msgbox(<span class="string">'No .DTA files could be found in that folder!'</span>,<span class="string">'Folder load error'</span>,<span class="string">'warn'</span>);
0292 <span class="keyword">end</span>
0293 
0294 
0295 <span class="comment">% --- Executes on selection change in listbox_files.</span>
0296 <a name="_sub6" href="#_subfunctions" class="code">function listbox_files_Callback(hObject, eventdata, handles)</a>
0297 
0298 
0299 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0300 <a name="_sub7" href="#_subfunctions" class="code">function listbox_files_CreateFcn(hObject, eventdata, handles)</a>
0301 
0302 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0303     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0304 <span class="keyword">end</span>
0305 
0306 <span class="comment">%  .oooooo..o                          .</span>
0307 <span class="comment">% d8P'    `Y8                        .o8</span>
0308 <span class="comment">% Y88bo.      oooo    ooo  .oooo.o .o888oo  .ooooo.  ooo. .oo.  .oo.</span>
0309 <span class="comment">%  `&quot;Y8888o.   `88.  .8'  d88(  &quot;8   888   d88' `88b `888P&quot;Y88bP&quot;Y88b</span>
0310 <span class="comment">%      `&quot;Y88b   `88..8'   `&quot;Y88b.    888   888ooo888  888   888   888</span>
0311 <span class="comment">% oo     .d8P    `888'    o.  )88b   888 . 888    .o  888   888   888</span>
0312 <span class="comment">% 8&quot;&quot;88888P'      .8'     8&quot;&quot;888P'   &quot;888&quot; `Y8bod8P' o888o o888o o888o</span>
0313 <span class="comment">%             .o..P'</span>
0314 <span class="comment">%             `Y8P'</span>
0315 
0316 <span class="comment">% --- Executes on selection change in edit_system.</span>
0317 <a name="_sub8" href="#_subfunctions" class="code">function edit_system_Callback(hObject, eventdata, handles)</a>
0318 
0319 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0320 <a name="_sub9" href="#_subfunctions" class="code">function edit_system_CreateFcn(hObject, eventdata, handles)</a>
0321 
0322 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0323     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0324 <span class="keyword">end</span>
0325 
0326 
0327 
0328 <span class="comment">% --- Executes on selection change in popupmenu_defaults.</span>
0329 <a name="_sub10" href="#_subfunctions" class="code">function popupmenu_defaults_Callback(hObject, eventdata, handles)</a>
0330 
0331 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0332 <a name="_sub11" href="#_subfunctions" class="code">function popupmenu_defaults_CreateFcn(hObject, eventdata, handles)</a>
0333 
0334 
0335 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
0336 <span class="comment">%       See ISPC and COMPUTER.</span>
0337 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0338     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0339 <span class="keyword">end</span>
0340 
0341 <span class="comment">% --- Executes on button press in button_systemLoad.</span>
0342 <a name="_sub12" href="#_subfunctions" class="code">function button_systemLoad_Callback(hObject, eventdata, handles)</a>
0343 
0344 <a href="#_sub42" class="code" title="subfunction defaultSelection(hObject, eventdata, handles)">defaultSelection</a>(hObject, eventdata, handles);
0345 
0346 
0347 <span class="comment">% oooooooooooo                                            o8o</span>
0348 <span class="comment">% `888'     `8                                            `&quot;'</span>
0349 <span class="comment">%  888         oooo    ooo oo.ooooo.   .ooooo.  oooo d8b oooo</span>
0350 <span class="comment">%  888oooo8     `88b..8P'   888' `88b d88' `88b `888&quot;&quot;8P `888</span>
0351 <span class="comment">%  888    &quot;       Y888'     888   888 888ooo888  888      888</span>
0352 <span class="comment">%  888       o  .o8&quot;'88b    888   888 888    .o  888      888</span>
0353 <span class="comment">% o888ooooood8 o88'   888o  888bod8P' `Y8bod8P' d888b    o888o</span>
0354 <span class="comment">%                           888</span>
0355 <span class="comment">%                          o888o</span>
0356 
0357 <span class="comment">% --- Executes on selection change in edit_exp.</span>
0358 <a name="_sub13" href="#_subfunctions" class="code">function edit_exp_Callback(hObject, eventdata, handles)</a>
0359 
0360 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0361 <a name="_sub14" href="#_subfunctions" class="code">function edit_exp_CreateFcn(hObject, eventdata, handles)</a>
0362 
0363 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0364     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0365 <span class="keyword">end</span>
0366 
0367 
0368 <span class="comment">% --- Executes on button press in button_expHelp.</span>
0369 <a name="_sub15" href="#_subfunctions" class="code">function button_expHelp_Callback(hObject, eventdata, handles)</a>
0370 
0371 msgbox(sprintf(<span class="string">'Experiment does not need field or frequency information as this will be automatically taken from the .DSC files\n\nYou must use Exp as the variable name'</span>)<span class="keyword">...</span>
0372     ,<span class="string">'Experiment help'</span>);
0373 
0374 
0375 <span class="comment">%</span>
0376 <span class="comment">%   .oooooo.                  .    o8o</span>
0377 <span class="comment">%  d8P'  `Y8b               .o8    `&quot;'</span>
0378 <span class="comment">% 888      888 oo.ooooo.  .o888oo oooo   .ooooo.  ooo. .oo.    .oooo.o</span>
0379 <span class="comment">% 888      888  888' `88b   888   `888  d88' `88b `888P&quot;Y88b  d88(  &quot;8</span>
0380 <span class="comment">% 888      888  888   888   888    888  888   888  888   888  `&quot;Y88b.</span>
0381 <span class="comment">% `88b    d88'  888   888   888 .  888  888   888  888   888  o.  )88b</span>
0382 <span class="comment">%  `Y8bood8P'   888bod8P'   &quot;888&quot; o888o `Y8bod8P' o888o o888o 8&quot;&quot;888P'</span>
0383 <span class="comment">%               888</span>
0384 <span class="comment">%              o888o</span>
0385 <span class="comment">%</span>
0386 
0387 <span class="comment">% --- Executes on button press in button_output.</span>
0388 <a name="_sub16" href="#_subfunctions" class="code">function button_output_Callback(hObject, eventdata, handles)</a>
0389 
0390 path = uigetdir(get(handles.edit_outputAddress,<span class="string">'String'</span>),<span class="string">'EasyRefiner: Load folder'</span>);
0391 set(handles.edit_outputAddress,<span class="string">'String'</span>,path);
0392 
0393 
0394 <a name="_sub17" href="#_subfunctions" class="code">function edit_outputAddress_Callback(hObject, eventdata, handles)</a>
0395 
0396 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0397 <a name="_sub18" href="#_subfunctions" class="code">function edit_outputAddress_CreateFcn(hObject, eventdata, handles)</a>
0398 
0399 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0400     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0401 <span class="keyword">end</span>
0402 
0403 <span class="comment">% --- Executes on button press in checkbox_figureOpen.</span>
0404 <a name="_sub19" href="#_subfunctions" class="code">function checkbox_figureOpen_Callback(hObject, eventdata, handles)</a>
0405 
0406 <span class="keyword">switch</span> get(handles.checkbox_figureOpen,<span class="string">'Value'</span>)
0407     <span class="keyword">case</span> 0
0408         <span class="comment">% Do nothing</span>
0409     <span class="keyword">case</span> 1
0410         set(handles.checkbox_figureSave,<span class="string">'Value'</span>,1);
0411 <span class="keyword">end</span>
0412 
0413 
0414 
0415 <span class="comment">% --- Executes on button press in checkbox_figureSave.</span>
0416 <a name="_sub20" href="#_subfunctions" class="code">function checkbox_figureSave_Callback(hObject, eventdata, handles)</a>
0417 
0418 
0419 <span class="comment">% --- Executes on button press in checkbox_delay.</span>
0420 <a name="_sub21" href="#_subfunctions" class="code">function checkbox_delay_Callback(hObject, eventdata, handles)</a>
0421 
0422 
0423 <span class="comment">% --- Executes on button press in checkbox_log.</span>
0424 <a name="_sub22" href="#_subfunctions" class="code">function checkbox_log_Callback(hObject, eventdata, handles)</a>
0425 
0426 
0427 <a name="_sub23" href="#_subfunctions" class="code">function edit_delay_Callback(hObject, eventdata, handles)</a>
0428 
0429 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0430 <a name="_sub24" href="#_subfunctions" class="code">function edit_delay_CreateFcn(hObject, eventdata, handles)</a>
0431 
0432 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0433     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0434 <span class="keyword">end</span>
0435 
0436 <span class="comment">% --- Executes on selection change in popupmenu_esFitting.</span>
0437 <a name="_sub25" href="#_subfunctions" class="code">function popupmenu_esFitting_Callback(hObject, eventdata, handles)</a>
0438 
0439 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0440 <a name="_sub26" href="#_subfunctions" class="code">function popupmenu_esFitting_CreateFcn(hObject, eventdata, handles)</a>
0441 
0442 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0443     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0444 <span class="keyword">end</span>
0445 
0446 
0447 <span class="comment">% --- Executes on selection change in popupmenu_esFitMethod.</span>
0448 <a name="_sub27" href="#_subfunctions" class="code">function popupmenu_esFitMethod_Callback(hObject, eventdata, handles)</a>
0449 
0450 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0451 <a name="_sub28" href="#_subfunctions" class="code">function popupmenu_esFitMethod_CreateFcn(hObject, eventdata, handles)</a>
0452 
0453 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0454     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0455 <span class="keyword">end</span>
0456 
0457 <a name="_sub29" href="#_subfunctions" class="code">function edit_opt_Callback(hObject, eventdata, handles)</a>
0458 
0459 
0460 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0461 <a name="_sub30" href="#_subfunctions" class="code">function edit_opt_CreateFcn(hObject, eventdata, handles)</a>
0462 
0463 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0464     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0465 <span class="keyword">end</span>
0466 
0467 
0468 <span class="comment">% oooooo     oooo                           .o</span>
0469 <span class="comment">%  `888.     .8'                          o888</span>
0470 <span class="comment">%   `888.   .8'    .oooo.   oooo d8b       888</span>
0471 <span class="comment">%    `888. .8'    `P  )88b  `888&quot;&quot;8P       888</span>
0472 <span class="comment">%     `888.8'      .oP&quot;888   888           888</span>
0473 <span class="comment">%      `888'      d8(  888   888           888</span>
0474 <span class="comment">%       `8'       `Y888&quot;&quot;8o d888b         o888o</span>
0475 <span class="comment">%</span>
0476 
0477 <span class="comment">% --- Executes on selection change in edit_var1.</span>
0478 <a name="_sub31" href="#_subfunctions" class="code">function edit_var1_Callback(hObject, eventdata, handles)</a>
0479 
0480 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0481 <a name="_sub32" href="#_subfunctions" class="code">function edit_var1_CreateFcn(hObject, eventdata, handles)</a>
0482 
0483 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0484     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0485 <span class="keyword">end</span>
0486 
0487 <span class="comment">% --- Executes on button press in checkbox_var1.</span>
0488 <a name="_sub33" href="#_subfunctions" class="code">function checkbox_var1_Callback(hObject, eventdata, handles)</a>
0489 
0490 <span class="keyword">switch</span> get(handles.checkbox_var1,<span class="string">'Value'</span>)
0491     <span class="keyword">case</span> 0
0492         set(handles.checkbox_var2,<span class="string">'Value'</span>,0);
0493         set(handles.checkbox_var3,<span class="string">'Value'</span>,0);
0494     <span class="keyword">case</span> 1
0495         
0496 <span class="keyword">end</span>
0497 
0498 <span class="comment">% oooooo     oooo                           .oooo.</span>
0499 <span class="comment">%  `888.     .8'                          .dP&quot;&quot;Y88b</span>
0500 <span class="comment">%   `888.   .8'    .oooo.   oooo d8b            ]8P'</span>
0501 <span class="comment">%    `888. .8'    `P  )88b  `888&quot;&quot;8P          .d8P'</span>
0502 <span class="comment">%     `888.8'      .oP&quot;888   888            .dP'</span>
0503 <span class="comment">%      `888'      d8(  888   888          .oP     .o</span>
0504 <span class="comment">%       `8'       `Y888&quot;&quot;8o d888b         8888888888</span>
0505 <span class="comment">%</span>
0506 
0507 <span class="comment">% --- Executes on selection change in edit_var2.</span>
0508 <a name="_sub34" href="#_subfunctions" class="code">function edit_var2_Callback(hObject, eventdata, handles)</a>
0509 
0510 
0511 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0512 <a name="_sub35" href="#_subfunctions" class="code">function edit_var2_CreateFcn(hObject, eventdata, handles)</a>
0513 
0514 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0515     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0516 <span class="keyword">end</span>
0517 
0518 <span class="comment">% --- Executes on button press in checkbox_var2.</span>
0519 <a name="_sub36" href="#_subfunctions" class="code">function checkbox_var2_Callback(hObject, eventdata, handles)</a>
0520 
0521 <span class="keyword">switch</span> get(handles.checkbox_var2,<span class="string">'Value'</span>)
0522     <span class="keyword">case</span> 0
0523         set(handles.checkbox_var3,<span class="string">'Value'</span>,0);
0524     <span class="keyword">case</span> 1
0525         set(handles.checkbox_var1,<span class="string">'Value'</span>,1);
0526 <span class="keyword">end</span>
0527 
0528 <span class="comment">% oooooo     oooo                           .oooo.</span>
0529 <span class="comment">%  `888.     .8'                          .dP&quot;&quot;Y88b</span>
0530 <span class="comment">%   `888.   .8'    .oooo.   oooo d8b            ]8P'</span>
0531 <span class="comment">%    `888. .8'    `P  )88b  `888&quot;&quot;8P          &lt;88b.</span>
0532 <span class="comment">%     `888.8'      .oP&quot;888   888               `88b.</span>
0533 <span class="comment">%      `888'      d8(  888   888          o.   .88P</span>
0534 <span class="comment">%       `8'       `Y888&quot;&quot;8o d888b         `8bd88P'</span>
0535 <span class="comment">%</span>
0536 
0537 <span class="comment">% --- Executes on selection change in edit_var3.</span>
0538 <a name="_sub37" href="#_subfunctions" class="code">function edit_var3_Callback(hObject, eventdata, handles)</a>
0539 
0540 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0541 <a name="_sub38" href="#_subfunctions" class="code">function edit_var3_CreateFcn(hObject, eventdata, handles)</a>
0542 
0543 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0544     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0545 <span class="keyword">end</span>
0546 
0547 <span class="comment">% --- Executes on button press in checkbox_var3.</span>
0548 <a name="_sub39" href="#_subfunctions" class="code">function checkbox_var3_Callback(hObject, eventdata, handles)</a>
0549 
0550 <span class="keyword">switch</span> get(handles.checkbox_var3,<span class="string">'Value'</span>)
0551     <span class="keyword">case</span> 0
0552         <span class="comment">% Do nothing</span>
0553     <span class="keyword">case</span> 1
0554         set(handles.checkbox_var1,<span class="string">'Value'</span>,1);
0555         set(handles.checkbox_var2,<span class="string">'Value'</span>,1);
0556 <span class="keyword">end</span>
0557 
0558 
0559 <span class="comment">% ooooo              .o88o.</span>
0560 <span class="comment">% `888'              888 `&quot;</span>
0561 <span class="comment">%  888  ooo. .oo.   o888oo   .ooooo.</span>
0562 <span class="comment">%  888  `888P&quot;Y88b   888    d88' `88b</span>
0563 <span class="comment">%  888   888   888   888    888   888</span>
0564 <span class="comment">%  888   888   888   888    888   888</span>
0565 <span class="comment">% o888o o888o o888o o888o   `Y8bod8P'</span>
0566 <span class="comment">%</span>
0567                                     
0568 <span class="comment">% --- Executes on selection change in edit_info.</span>
0569 <a name="_sub40" href="#_subfunctions" class="code">function edit_info_Callback(hObject, eventdata, handles)</a>
0570 
0571 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0572 <a name="_sub41" href="#_subfunctions" class="code">function edit_info_CreateFcn(hObject, eventdata, handles)</a>
0573 
0574 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0575     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0576 <span class="keyword">end</span>
0577 
0578 <span class="comment">% oooooooooooo                                       .    o8o</span>
0579 <span class="comment">% `888'     `8                                     .o8    `&quot;'</span>
0580 <span class="comment">%  888         oooo  oooo  ooo. .oo.    .ooooo.  .o888oo oooo   .ooooo.  ooo. .oo.    .oooo.o</span>
0581 <span class="comment">%  888oooo8    `888  `888  `888P&quot;Y88b  d88' `&quot;Y8   888   `888  d88' `88b `888P&quot;Y88b  d88(  &quot;8</span>
0582 <span class="comment">%  888    &quot;     888   888   888   888  888         888    888  888   888  888   888  `&quot;Y88b.</span>
0583 <span class="comment">%  888          888   888   888   888  888   .o8   888 .  888  888   888  888   888  o.  )88b</span>
0584 <span class="comment">% o888o         `V88V&quot;V8P' o888o o888o `Y8bod8P'   &quot;888&quot; o888o `Y8bod8P' o888o o888o 8&quot;&quot;888P'</span>
0585                                                                                             
0586 
0587 <a name="_sub42" href="#_subfunctions" class="code">function defaultSelection(hObject, eventdata, handles)</a>
0588 
0589 <span class="comment">% Clear all edit boxes</span>
0590 set(handles.edit_system,<span class="string">'String'</span>,<span class="string">''</span>);
0591 set(handles.edit_exp ,<span class="string">'String'</span>,<span class="string">''</span>);
0592 set(handles.edit_var1,<span class="string">'String'</span>,<span class="string">''</span>);
0593 set(handles.edit_var2,<span class="string">'String'</span>,<span class="string">''</span>);
0594 set(handles.edit_var3,<span class="string">'String'</span>,<span class="string">''</span>);
0595 
0596 
0597 <span class="comment">% Get listbox</span>
0598 <span class="keyword">switch</span> get(handles.popupmenu_defaults,<span class="string">'Value'</span>)
0599     <span class="keyword">case</span> 1  <span class="comment">% Nitroxide</span>
0600         set(handles.edit_system,<span class="string">'String'</span>,[<span class="keyword">...</span>
0601         <span class="string">'Sys.g = [2.02 2.01 2.00];   '</span>;<span class="keyword">...</span>
0602         <span class="string">'Sys.Nucs = ''14N'';           '</span>;<span class="keyword">...</span>
0603         <span class="string">'Sys.A = [20 20 85];         '</span>;<span class="keyword">...</span>
0604         <span class="string">'Sys.n = 1;                  '</span>;<span class="keyword">...</span>
0605         <span class="string">'Sys.lwpp = 0.25;            '</span>]);
0606     
0607         set(handles.edit_var1,<span class="string">'String'</span>,[<span class="keyword">...</span>
0608         <span class="string">'Var.g = [0.01 0.01 0.01];   '</span>;<span class="keyword">...</span>
0609         <span class="string">'Var.A = [2 2 2];            '</span>;<span class="keyword">...</span>
0610         <span class="string">'Var.lwpp = 0.05;            '</span>]);
0611     
0612         set(handles.edit_var2,<span class="string">'String'</span>,[<span class="keyword">...</span>
0613         <span class="string">'Var.g = [0.001 0.001 0.001];'</span>;<span class="keyword">...</span>
0614         <span class="string">'Var.A = [0.5 0.5 0.5];      '</span>;<span class="keyword">...</span>
0615         <span class="string">'Var.lwpp = 0.01;            '</span>]);
0616     
0617         set(handles.edit_var3,<span class="string">'String'</span>,[<span class="keyword">...</span>
0618         <span class="string">'Var.g = [0.0005 0.0005 0.0005];'</span>;<span class="keyword">...</span>
0619         <span class="string">'Var.A = [0.001 0.001 0.001];   '</span>;<span class="keyword">...</span>
0620         <span class="string">'Var.lwpp = 0.001;              '</span>]);
0621     
0622         set(handles.edit_opt,<span class="string">'String'</span>,[<span class="keyword">...</span>
0623             <span class="string">'FitOpt.PopulationSize = 80;'</span>;<span class="keyword">...</span>
0624             <span class="string">'FitOpt.maxGenerations = 80;'</span>]);
0625             
0626     
0627     <span class="keyword">case</span> 2  <span class="comment">% Fremy's</span>
0628         set(handles.edit_system,<span class="string">'String'</span>,[<span class="keyword">...</span>
0629         <span class="string">'Sys.g = [2.00785 2.00590 2.00265];'</span>;<span class="keyword">...</span>
0630         <span class="string">'Sys.Nucs = ''14N'';                 '</span>;<span class="keyword">...</span>
0631         <span class="string">'Sys.A = [15.4137 14.0125 80.4316];'</span>;<span class="keyword">...</span>
0632         <span class="string">'Sys.n = 1;                        '</span>;<span class="keyword">...</span>
0633         <span class="string">'Sys.lw = [0 0.03];                '</span>]);
0634     
0635         set(handles.edit_var1,<span class="string">'String'</span>,[<span class="keyword">...</span>
0636         <span class="string">'Var.g = [0.005 0.005 0.005];'</span>;<span class="keyword">...</span>
0637         <span class="string">'Var.lwpp = 0.001;           '</span>]);
0638     
0639         
0640     <span class="keyword">case</span> 3  <span class="comment">% DPPH</span>
0641          set(handles.edit_system,<span class="string">'String'</span>,[<span class="keyword">...</span>
0642         <span class="string">'Sys.g = 2.0036;    '</span>;<span class="keyword">...</span>
0643         <span class="string">'Sys.Nucs = ''14N'';  '</span>;<span class="keyword">...</span>
0644         <span class="string">'Sys.n = 1;         '</span>;<span class="keyword">...</span>
0645         <span class="string">'Sys.lw = 0 0.005;  '</span>]);
0646     
0647     set(handles.edit_var1,<span class="string">'String'</span>,[<span class="keyword">...</span>
0648         <span class="string">'Var.g = 0.005;'</span>]);
0649     
0650 <span class="keyword">end</span>
0651 
0652 <span class="comment">% --- Executes on button press in button_RUN.</span>
0653 <a name="_sub43" href="#_subfunctions" class="code">function button_RUN_Callback(hObject, eventdata, handles)</a>
0654 
0655 <span class="comment">% Check for EasySpin</span>
0656 <span class="keyword">if</span> exist(<span class="string">'esfit'</span>) == 0
0657     msgbox(<span class="string">'EasySpin could not be found. Please check that it is installed and on an active path.'</span>,<span class="string">'EasyRefiner: RUN'</span>,<span class="string">'error'</span>);
0658     <span class="keyword">return</span>
0659 <span class="keyword">end</span>
0660 
0661 
0662 <span class="comment">% Message user</span>
0663 info = [sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'EASYREFINER INITIALIZING:'</span>])];
0664 set(handles.edit_info,<span class="string">'String'</span>,info);
0665 
0666 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Loading variables...'</span>])];
0667 set(handles.edit_info,<span class="string">'String'</span>,info);
0668 
0669 <span class="comment">% Check file has been loaded, otherwise abort</span>
0670 <span class="keyword">if</span> strcmp(get(handles.listbox_files,<span class="string">'String'</span>), <span class="string">'-- No file loaded --'</span>)
0671     info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'No files loaded, aborting'</span>])];
0672     set(handles.edit_info,<span class="string">'String'</span>,info);
0673     <span class="keyword">return</span>
0674 <span class="keyword">end</span>
0675 
0676 <span class="comment">% Get all variables</span>
0677 <span class="keyword">global</span> ER
0678 var1On  = get(handles.checkbox_var1,<span class="string">'Value'</span>);
0679 var2On  = get(handles.checkbox_var2,<span class="string">'Value'</span>);
0680 var3On  = get(handles.checkbox_var3,<span class="string">'Value'</span>);
0681 figOpen = get(handles.checkbox_figureOpen,<span class="string">'Value'</span>);
0682 figSave = get(handles.checkbox_figureSave,<span class="string">'Value'</span>);
0683 log     = get(handles.checkbox_log,<span class="string">'Value'</span>);
0684 outAdd  = get(handles.edit_outputAddress,<span class="string">'String'</span>);
0685 
0686 <span class="keyword">if</span> get(handles.checkbox_delay,<span class="string">'Value'</span>) == 1
0687     delay = str2num(get(handles.edit_delay,<span class="string">'String'</span>));
0688 <span class="keyword">else</span>
0689     delay = 0;
0690 <span class="keyword">end</span>
0691 
0692 <span class="comment">% Get strings from edit boxes</span>
0693 sSys    = get(handles.edit_system,<span class="string">'String'</span>);
0694 sExp    = get(handles.edit_exp,<span class="string">'String'</span>);
0695 sOpt    = get(handles.edit_opt,<span class="string">'String'</span>);
0696 sVar1   = get(handles.edit_var1,<span class="string">'String'</span>);
0697 sVar2   = get(handles.edit_var2,<span class="string">'String'</span>);
0698 sVar3   = get(handles.edit_var3,<span class="string">'String'</span>);
0699 
0700 <span class="comment">% Fitting options</span>
0701 <span class="keyword">switch</span> get(handles.popupmenu_esFitting,<span class="string">'Value'</span>);
0702     <span class="keyword">case</span> 1  <span class="comment">% Garlic</span>
0703         Fit = <span class="string">'garlic'</span>;
0704     <span class="keyword">case</span> 2  <span class="comment">% Chili</span>
0705         Fit = <span class="string">'chili'</span>;
0706     <span class="keyword">case</span> 3  <span class="comment">% Pepper</span>
0707         Fit = <span class="string">'pepper'</span>;
0708 <span class="keyword">end</span>
0709 
0710 <span class="comment">% Fitting method</span>
0711 <span class="keyword">switch</span> get(handles.popupmenu_esFitMethod,<span class="string">'Value'</span>)
0712     <span class="keyword">case</span> 1
0713         FitOpt.Method = <span class="string">'simplex'</span>;
0714         Opt = [];
0715     <span class="keyword">case</span> 2
0716         FitOpt.Method = <span class="string">'levmar'</span>;
0717         Opt = [];
0718     <span class="keyword">case</span> 3
0719         FitOpt.Method = <span class="string">'montecarlo'</span>;
0720         Opt = [];
0721     <span class="keyword">case</span> 4
0722         FitOpt.Method = <span class="string">'genetic'</span>;
0723         Opt = [];
0724     <span class="keyword">case</span> 5
0725         FitOpt.Method = <span class="string">'grid'</span>;
0726         Opt = [];
0727 <span class="keyword">end</span>
0728 
0729 
0730 
0731 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Fitting with '</span> Fit ])];
0732 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) FitOpt.Method <span class="string">' method selected'</span>])];
0733 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0734 
0735 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Variables loaded!'</span>])];
0736 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0737 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Beginning fitting...'</span>])];
0738 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0739 
0740 files = ER.fileNum;
0741 
0742 <span class="comment">% Start timers</span>
0743 timeBegin = tic;
0744 wb = waitbar(0,sprintf(<span class="string">'Completed 0 of %1d'</span>,files),<span class="string">'Name'</span>,<span class="string">'Close to cancel queue'</span>);
0745 
0746 <span class="comment">% Begin fitting</span>
0747 <span class="keyword">for</span> k = 1:files
0748         
0749     <span class="comment">% Evaluate system and options line by line</span>
0750     <span class="keyword">for</span> l = 1:size(sSys,1)
0751         eval(sSys(l,:));
0752     <span class="keyword">end</span>
0753     
0754     <span class="keyword">for</span> l = 1:size(sOpt,1)
0755         eval(sOpt(l,:));
0756     <span class="keyword">end</span>
0757     
0758     <span class="comment">% Evaluate experiment</span>
0759     <span class="keyword">for</span> l = 1:size(sExp,1)
0760         eval(sExp(l,:));
0761     <span class="keyword">end</span>
0762     
0763     <span class="comment">% Pull mw frequency from file's info and evaluate</span>
0764     eval([<span class="string">'Exp.mwFreq = '</span> num2str(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.MWFQ/10^9) <span class="string">';'</span>]);
0765     eval([<span class="string">'Exp.Range = ['</span> num2str(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x(1)/10) <span class="string">' '</span> num2str(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x(end)/10) <span class="string">'];'</span>]);
0766    
0767     timeVar1 = tic;
0768    
0769     str = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Beginning file '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0770     info = [info ; str(1:50)];
0771     set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0772     
0773     <span class="keyword">switch</span> var1On
0774         <span class="keyword">case</span> 0
0775             <span class="comment">% If no variable selected</span>
0776             eval([<span class="string">'[B,spc] = '</span> Fit <span class="string">'('</span> Sys <span class="string">','</span> Exp <span class="string">');'</span>]);
0777         <span class="keyword">case</span> 1
0778             <span class="comment">% If var1 ticked, evaluate</span>
0779             <span class="keyword">for</span> l = 1:size(sVar1,1)
0780                 eval(sVar1(l,:));
0781             <span class="keyword">end</span>
0782             
0783             info = [info;sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Starting round 1'</span>])];
0784             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0785             
0786             <span class="comment">% Have to autozero spectra for EasySpin</span>
0787             m = mean([(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).y(end-4:<span class="keyword">end</span>,1)) ; (ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).y(1:5,1))]);
0788             ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).y(:,1) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).y(:,1) - (m);
0789                        
0790             <span class="comment">% Call EasySpin</span>
0791             disp([datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'File '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL , <span class="string">'round 1'</span>]);
0792             
0793             <span class="keyword">try</span>
0794                 eval([<span class="string">'[bestsys,bestspc] = esfit('''</span> Fit <span class="string">''', ER.data.File'</span> num2str(k) <span class="string">'.y , Sys, Var, Exp , Opt, FitOpt);'</span>]);
0795             <span class="keyword">catch</span>
0796                 fail = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'FAILED round 1 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0797                 info = [info ; fail(1:50)];
0798                 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0799                 <span class="keyword">continue</span>
0800             <span class="keyword">end</span>
0801             
0802             str2 = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Completed round 1 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0803             
0804             info = [info ; str2(1:50)];
0805             info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Round 1 time taken: '</span> num2str(round(toc(timeVar1))) <span class="string">' s'</span>])];
0806             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0807             
0808             
0809             <span class="comment">% Save variables</span>
0810             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r1.bestsys = bestsys;
0811             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r1.bestspc = bestspc;
0812             
0813             <span class="comment">% Save the figure?</span>
0814             <span class="keyword">switch</span> figSave
0815                 <span class="keyword">case</span> 0
0816                     <span class="comment">% Do nothing</span>
0817                 <span class="keyword">case</span> 1
0818                     <span class="comment">% Save the figure</span>
0819                     saveas(gcf,[outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r1.fig'</span>]);
0820             <span class="keyword">end</span>
0821             
0822             close(gcf);
0823             
0824             <span class="comment">% Keep the figure open?</span>
0825             <span class="keyword">switch</span> figOpen
0826                 <span class="keyword">case</span> 0
0827                     <span class="comment">% Do nothing</span>
0828                 <span class="keyword">case</span> 1
0829                     openfig([outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r1.fig'</span>],<span class="string">'new'</span>);
0830                     set(gcf,<span class="string">'Name'</span>,[<span class="string">'EasyRefiner - '</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">' - Round 1'</span>]);
0831             <span class="keyword">end</span>
0832             
0833             <span class="comment">% Delay between fitting</span>
0834             <span class="keyword">switch</span> delay
0835                 <span class="keyword">case</span> 0
0836                     
0837                 <span class="keyword">otherwise</span>
0838                     pause(delay)
0839             <span class="keyword">end</span>
0840     <span class="keyword">end</span>
0841     
0842     <span class="keyword">switch</span> var2On
0843         <span class="keyword">case</span> 0
0844             <span class="comment">% Do nothing</span>
0845         <span class="keyword">case</span> 1
0846             timeVar2 = tic;
0847 
0848             <span class="comment">% Start round 2</span>
0849             info = [info;sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Starting round 2'</span>])];
0850             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0851             
0852             <span class="comment">% Evaluate variables</span>
0853             <span class="keyword">for</span> l = 1:size(sVar2,1)
0854                 eval(sVar2(l,:));
0855             <span class="keyword">end</span>
0856                       
0857             <span class="comment">% Call EasySpin</span>
0858             disp([datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'File '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL , <span class="string">'round 2'</span>]);
0859             
0860             <span class="keyword">try</span>
0861                 eval([<span class="string">'[bestsys,bestspc] = esfit('''</span> Fit <span class="string">''', ER.data.File'</span> num2str(k) <span class="string">'.y , bestsys, Var, Exp , Opt, FitOpt);'</span>]);
0862             <span class="keyword">catch</span>
0863                 fail = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'FAILED round 2 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0864                 info = [info ; fail(1:50)];
0865                 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0866                 <span class="keyword">continue</span>
0867             <span class="keyword">end</span>
0868             
0869             <span class="comment">% Report to user</span>
0870             str3 = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Completed round 2 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0871             info = [info ; str3(1:50)];
0872             info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Round 2 time taken: '</span> num2str(round(toc(timeVar2))) <span class="string">' s'</span>])];
0873             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0874             
0875             <span class="comment">% Save variables</span>
0876             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r2.bestsys = bestsys;
0877             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r2.bestspc = bestspc;
0878             
0879             <span class="comment">% Save the figure?</span>
0880             <span class="keyword">switch</span> figSave
0881                 <span class="keyword">case</span> 0
0882                     <span class="comment">% Do nothing</span>
0883                 <span class="keyword">case</span> 1
0884                     <span class="comment">% Save the figure</span>
0885                     saveas(gcf,[outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r2.fig'</span>]);
0886             <span class="keyword">end</span>
0887             
0888             close(gcf);
0889             
0890             <span class="comment">% Keep the figure open?</span>
0891             <span class="keyword">switch</span> figOpen
0892                 <span class="keyword">case</span> 0
0893                     <span class="comment">% Do nothing</span>
0894                 <span class="keyword">case</span> 1
0895                     openfig([outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r2.fig'</span>],<span class="string">'new'</span>);
0896                     set(gcf,<span class="string">'Name'</span>,[<span class="string">'EasyRefiner - '</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">' - Round 2'</span>]);
0897             <span class="keyword">end</span>
0898             
0899             <span class="comment">% Delay between fitting</span>
0900             <span class="keyword">switch</span> delay
0901                 <span class="keyword">case</span> 0
0902                     
0903                 <span class="keyword">otherwise</span>
0904                     pause(delay)
0905             <span class="keyword">end</span>
0906     <span class="keyword">end</span>
0907     
0908     <span class="keyword">switch</span> var3On
0909         <span class="keyword">case</span> 0
0910             <span class="comment">% Do nothing</span>
0911         <span class="keyword">case</span> 1
0912             timeVar3 = tic;
0913 
0914             <span class="comment">% Start round 3</span>
0915             info = [info;sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Starting round 3'</span>])];
0916             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0917             
0918             <span class="comment">% Evaluate variables</span>
0919             <span class="keyword">for</span> l = 1:size(sVar3,1)
0920                 eval(sVar3(l,:));
0921             <span class="keyword">end</span>
0922             
0923             <span class="comment">% Call EasySpin</span>
0924             disp([datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'File '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL , <span class="string">'round 3'</span>]);
0925             
0926             <span class="keyword">try</span>
0927                 eval([<span class="string">'[bestsys,bestspc] = esfit('''</span> Fit <span class="string">''', ER.data.File'</span> num2str(k) <span class="string">'.y , bestsys, Var, Exp , Opt, FitOpt);'</span>])
0928             <span class="keyword">catch</span>
0929                 fail = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'FAILED round 3 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0930                 info = [info ; fail(1:50)];
0931                 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0932                 <span class="keyword">continue</span>
0933             <span class="keyword">end</span>
0934             
0935             <span class="comment">% Report to user</span>
0936             str4 = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Completed round 3 of '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0937             info = [info ; str4(1:50)];
0938             info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Round 3 time taken: '</span> num2str(round(toc(timeVar3))) <span class="string">' s'</span>])];
0939             set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0940             
0941             <span class="comment">% Save variables</span>
0942             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r3.bestsys = bestsys;
0943             Results.(strcat(<span class="string">'File'</span>,num2str(k))).r3.bestspc = bestspc;
0944             
0945             <span class="comment">% Save the figure?</span>
0946             <span class="keyword">switch</span> figSave
0947                 <span class="keyword">case</span> 0
0948                     <span class="comment">% Do nothing</span>
0949                 <span class="keyword">case</span> 1
0950                     <span class="comment">% Save the figure</span>
0951                     saveas(gcf,[outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r3.fig'</span>]);
0952             <span class="keyword">end</span>
0953             
0954             close(gcf);
0955             
0956             <span class="comment">% Keep the figure open?</span>
0957             <span class="keyword">switch</span> figOpen
0958                 <span class="keyword">case</span> 0
0959                     <span class="comment">% Do nothing</span>
0960                 <span class="keyword">case</span> 1
0961                     openfig([outAdd <span class="string">'/'</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">'r3.fig'</span>],<span class="string">'new'</span>);
0962                     set(gcf,<span class="string">'Name'</span>,[<span class="string">'EasyRefiner - '</span> regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">''''</span>,<span class="string">''</span>) <span class="string">' - Round 3'</span>]);
0963             <span class="keyword">end</span>
0964             
0965             <span class="comment">% Delay between fitting</span>
0966             <span class="keyword">switch</span> delay
0967                 <span class="keyword">case</span> 0
0968                     
0969                 <span class="keyword">otherwise</span>
0970                     pause(delay)
0971             <span class="keyword">end</span>
0972     <span class="keyword">end</span>
0973      
0974     <span class="comment">% Message user for file completion</span>
0975     str5 = sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Completed file '</span> ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL]);
0976     info = [info ; str5(1:50)];
0977     info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'File time taken: '</span> num2str(round(toc(timeVar1))) <span class="string">' s'</span>])];
0978     set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
0979     
0980     <span class="comment">% Update progress bar</span>
0981     <span class="keyword">try</span>
0982         wb = waitbar((k/files)-(1/files),wb,sprintf(<span class="string">'Completed %1d of %1d'</span>,k,files));
0983     <span class="keyword">catch</span>
0984         msgbox(<span class="string">'Fitting canceled by user'</span>,<span class="string">'EasyRefiner'</span>,<span class="string">'error'</span>) ;
0985         <span class="keyword">return</span>
0986     <span class="keyword">end</span>
0987     
0988 <span class="keyword">end</span>
0989 
0990 delete(wb);
0991 
0992 <span class="comment">% Process the outputs</span>
0993 out =[];
0994 
0995 <span class="keyword">for</span> k = 1:files
0996     
0997     <span class="comment">% Create nice array of data for plotting &amp; copy EasySpin results</span>
0998     
0999     <span class="comment">% Column 1 and 2 are original data</span>
1000     ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,1) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x;
1001     ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,2) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).y;
1002     <span class="comment">% Column 3 and 4 is round 1</span>
1003     ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,3) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x;
1004     ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,4) = (Results.(strcat(<span class="string">'File'</span>,num2str(k))).r1.bestspc)';
1005     
1006     ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Fits.r1    = Results.(strcat(<span class="string">'File'</span>,num2str(k))).r1.bestsys;
1007     
1008     <span class="keyword">if</span> isfield(Results.(strcat(<span class="string">'File'</span>,num2str(k))),<span class="string">'r2'</span>)
1009         <span class="comment">% Column 5 and 6 is round 2</span>
1010         ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,5) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x;
1011         ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,6) = (Results.(strcat(<span class="string">'File'</span>,num2str(k))).r2.bestspc)';
1012         
1013         ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Fits.r2    = Results.(strcat(<span class="string">'File'</span>,num2str(k))).r2.bestsys;
1014         
1015         <span class="keyword">if</span> isfield(Results.(strcat(<span class="string">'File'</span>,num2str(k))),<span class="string">'r3'</span>)
1016             <span class="comment">% Column 7 and 8 is round 3</span>
1017             ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,7) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).x;
1018             ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Plots(:,8) = (Results.(strcat(<span class="string">'File'</span>,num2str(k))).r3.bestspc)';
1019             
1020             ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).Fits.r3    = Results.(strcat(<span class="string">'File'</span>,num2str(k))).r3.bestsys;
1021         <span class="keyword">end</span>
1022     <span class="keyword">end</span>
1023     
1024     <span class="comment">% Rename FileX to out.{FileTitle}</span>
1025     <span class="keyword">try</span>
1026         out.(regexprep(ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL,<span class="string">'[- \/'']'</span>,<span class="string">''</span>)) = ER.data.(strcat(<span class="string">'File'</span>,num2str(k)));
1027     <span class="keyword">catch</span>
1028         error(<span class="string">'%s is not a valid file name and will be skipped'</span>, ER.data.(strcat(<span class="string">'File'</span>,num2str(k))).info.TITL);
1029         <span class="keyword">continue</span>
1030     <span class="keyword">end</span>
1031 <span class="keyword">end</span>
1032 
1033 <span class="comment">% Save the results</span>
1034 save([outAdd <span class="string">'/'</span> datestr(now, <span class="string">'dd-mm-yy_HH:MM_'</span>) <span class="string">'EasyRefiner_Results.mat'</span>],<span class="string">'out'</span>);
1035 <span class="comment">% Put output to base workspace</span>
1036 assignin(<span class="string">'base'</span>,<span class="string">'EasyRefiner_Results'</span>,out);
1037 
1038 <span class="comment">% Message user for queue completion</span>
1039 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Completed queue!'</span>])];
1040 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Queue time taken: '</span> num2str(round(toc(timeBegin))) <span class="string">' s'</span>])];
1041 set(handles.edit_info,<span class="string">'String'</span>,info(end-2:<span class="keyword">end</span> , :));
1042 
1043 <span class="keyword">switch</span> log
1044     <span class="keyword">case</span> 0
1045         <span class="comment">% Do nothing</span>
1046     <span class="keyword">case</span> 1
1047         <span class="comment">% Save out info</span>
1048         logFile = fopen([outAdd <span class="string">'/'</span> datestr(now, <span class="string">'dd-mm-yy_HH:MM_'</span>) <span class="string">'EasyRefiner_Log.txt'</span>],<span class="string">'w'</span>);
1049         
1050         <span class="keyword">for</span> k = 1:size(info,1)
1051             fprintf(logFile,<span class="string">'%-50s\n'</span>,info(k,:));
1052         <span class="keyword">end</span>
1053         
1054         fclose(logFile);
1055 <span class="keyword">end</span>
1056 
1057 
1058 <span class="comment">% --- Executes on button press in button_RunLater.</span>
1059 <a name="_sub44" href="#_subfunctions" class="code">function button_RunLater_Callback(hObject, eventdata, handles)</a>
1060 
1061 timenow = datevec(now);
1062 
1063 prompt = <span class="string">'When would like the queue to start? (dd-mm-yy HH:MM:SS)'</span>;
1064 dlg_title = <span class="string">'Delay queue start'</span>;
1065 num_lines = 1;
1066 def = {[num2str(timenow(3)) <span class="string">'-'</span> num2str(timenow(2)) <span class="string">'-'</span> num2str(timenow(1)) <span class="string">' '</span>,<span class="keyword">...</span>
1067     num2str(timenow(4)) <span class="string">':'</span> num2str(timenow(5)+5) <span class="string">':00'</span>]};
1068 
1069 start = inputdlg(prompt,dlg_title,num_lines,def);
1070 
1071 
1072 t1 = datevec(start,<span class="string">'dd-mm-yy HH:MM:SS'</span>);
1073 t2 = clock;
1074 
1075 diff = etime(t1,t2);
1076 
1077 info = [sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'EasyRefiner has been queued:'</span> ])];
1078 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Starting at:'</span> datestr(t1, <span class="string">'dd-mm-yy HH:MM:SS '</span>)])];
1079 info = [info ; sprintf(<span class="string">'%-50s'</span>,[datestr(now, <span class="string">'dd-mm-yy HH:MM:SS '</span>) <span class="string">'Waiting: '</span> num2str(round(diff)) <span class="string">' s'</span>])];
1080 set(handles.edit_info,<span class="string">'String'</span>,info);
1081 
1082 pause(diff);
1083 
1084 <a href="#_sub43" class="code" title="subfunction button_RUN_Callback(hObject, eventdata, handles)">button_RUN_Callback</a>(hObject, eventdata, handles);</pre></div>
<hr><address>Generated on Tue 15-Apr-2014 15:10:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>