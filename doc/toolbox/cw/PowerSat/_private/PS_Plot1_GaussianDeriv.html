<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of PS_Plot1_GaussianDeriv</title>
  <meta name="keywords" content="PS_Plot1_GaussianDeriv">
  <meta name="description" content="PS_PLOT1_GAUSSIAN Use a Gaussian fitting model to fit the model high">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="../../../index.html">toolbox</a> &gt; <a href="../../index.html">cw</a> &gt; <a href="../index.html">PowerSat</a> &gt; <a href="index.html">_private</a> &gt; PS_Plot1_GaussianDeriv.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for toolbox/cw/PowerSat/_private&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>PS_Plot1_GaussianDeriv
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>PS_PLOT1_GAUSSIAN Use a Gaussian fitting model to fit the model high</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function PS_Plot1_GaussianDeriv(handles,Exp) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> PS_PLOT1_GAUSSIAN Use a Gaussian fitting model to fit the model high
 and low points of the graph. The high and low peak points are then
 calculated from the result of the fit

 This file takes a certain amount of inspiration from lorentzfit freely
 available from Matlab Central File Exchange:
 http://www.mathworks.com/matlabcentral/fileexchange/33775-lorentzian-fit

 Syntax:  PS_PLOT1_GAUSSIAN

 Inputs:
    input1 - handles

    input2 - Exp
               experiment variable (ie Oxy,N2,Ni)

 Outputs:
    output1 - mwPower
               the microwave power of the currently displayed spectrum

 Example: 
    see http://morganbye.net/PowerSat

 Other m-files required:
    PowerSat.m

 Subfunctions:         none

 MAT-files required:   none

 References:   Equations for first and second derivative Gaussian's taken
               from www.hulinks.co.jp/software/peakfit/functions.html</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="PS_Plot1_PlotAll.html" class="code" title="function PS_Plot1_PlotAll(handles,graph,exp,color)">PS_Plot1_PlotAll</a>	PS_Plot1_PlotAll Plot all spectra from one experiment at once</li><li><a href="PS_Plot1_PlotSingle.html" class="code" title="function [mwPower] = PS_Plot1_PlotSingle(handles,graph,exp,color)">PS_Plot1_PlotSingle</a>	PS_Plot1_PlotSingle Plot one spectrum from an experiment.</li><li><a href="PS_PlotPS_Plot.html" class="code" title="function PS_PlotPS_Plot(handles,exp,color)">PS_PlotPS_Plot</a>	PS_PLOTPS_Plot Plot the power saturation curves</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function PS_Plot1_GaussianDeriv(handles,Exp)</a>
0002 
0003 <span class="comment">% PS_PLOT1_GAUSSIAN Use a Gaussian fitting model to fit the model high</span>
0004 <span class="comment">% and low points of the graph. The high and low peak points are then</span>
0005 <span class="comment">% calculated from the result of the fit</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% This file takes a certain amount of inspiration from lorentzfit freely</span>
0008 <span class="comment">% available from Matlab Central File Exchange:</span>
0009 <span class="comment">% http://www.mathworks.com/matlabcentral/fileexchange/33775-lorentzian-fit</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Syntax:  PS_PLOT1_GAUSSIAN</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Inputs:</span>
0014 <span class="comment">%    input1 - handles</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%    input2 - Exp</span>
0017 <span class="comment">%               experiment variable (ie Oxy,N2,Ni)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% Outputs:</span>
0020 <span class="comment">%    output1 - mwPower</span>
0021 <span class="comment">%               the microwave power of the currently displayed spectrum</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Example:</span>
0024 <span class="comment">%    see http://morganbye.net/PowerSat</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Other m-files required:</span>
0027 <span class="comment">%    PowerSat.m</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Subfunctions:         none</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% MAT-files required:   none</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% References:   Equations for first and second derivative Gaussian's taken</span>
0034 <span class="comment">%               from www.hulinks.co.jp/software/peakfit/functions.html</span>
0035 
0036 <span class="comment">%                                        _                             _</span>
0037 <span class="comment">%                                       | |                           | |</span>
0038 <span class="comment">%  _ __ ___   ___  _ __ __ _  __ _ _ __ | |__  _   _  ___   _ __   ___| |_</span>
0039 <span class="comment">% | '_ ` _ \ / _ \| '__/ _` |/ _` | '_ \| '_ \| | | |/ _ \ | '_ \ / _ \ __|</span>
0040 <span class="comment">% | | | | | | (_) | | | (_| | (_| | | | | |_) | |_| |  __/_| | | |  __/ |_</span>
0041 <span class="comment">% |_| |_| |_|\___/|_|  \__, |\__,_|_| |_|_.__/ \__, |\___(_)_| |_|\___|\__|</span>
0042 <span class="comment">%                       __/ |                   __/ |</span>
0043 <span class="comment">%                      |___/                   |___/</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%</span>
0046 <span class="comment">% M. Bye v12.8</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% Author:       Morgan Bye</span>
0049 <span class="comment">% Work address: Henry Wellcome Unit for Biological EPR</span>
0050 <span class="comment">%               University of East Anglia</span>
0051 <span class="comment">%               NORWICH, UK</span>
0052 <span class="comment">% Email:        morgan.bye@uea.ac.uk</span>
0053 <span class="comment">% Website:      http://www.morganbye.net/PowerSat</span>
0054 <span class="comment">% Aug 2012;     Last revision: 15-August-2012</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% Version history:</span>
0057 <span class="comment">% Aug 12        &gt; Initial release</span>
0058 
0059 <span class="comment">% Note to self:</span>
0060 <span class="comment">% In this script only the shorthand for experiment is Exp not exp like</span>
0061 <span class="comment">% everything else because otherwise the calculation of y of the Gaussian</span>
0062 <span class="comment">% doesnt work as it tries to call the string of exp and not the function</span>
0063 <span class="comment">% exp (exponential)</span>
0064 
0065 <span class="comment">% Get variables</span>
0066 warning off
0067 <span class="keyword">global</span> vars
0068 
0069 x       = vars.(Exp).x;
0070 y       = vars.(Exp).y0;
0071 info    = vars.(Exp).info;
0072 maxpeak = vars.(Exp).MaxPeak;
0073 minpeak = vars.(Exp).MinPeak;
0074 warning on
0075 
0076 <span class="comment">% Set up the window in which to fit</span>
0077 window  = str2double(get(handles.edit_fittingWindow,<span class="string">'String'</span>));
0078 
0079 window_midpoint = (maxpeak + minpeak)/2;
0080 window_high     = minpeak + (window/2);
0081 window_low      = maxpeak - (window/2);
0082 
0083 <span class="comment">% FIT SETUP</span>
0084 <span class="comment">% ========================================================================</span>
0085 
0086 <span class="comment">% Get data within window</span>
0087 [arb, SIG_WindUp] = min(abs(x-window_high));
0088 [arb, SIG_WindLo] = min(abs(x-window_low));
0089 
0090 <span class="comment">% Resize x and y to only include the window</span>
0091 yP = y (SIG_WindLo:SIG_WindUp,:);
0092 xP = x (SIG_WindLo:SIG_WindUp,:);
0093 
0094 <span class="comment">% Fit options</span>
0095 f = fittype(<span class="string">'(-a).*((x-b)./((c).^2)).*(exp(-0.5.*(((x-b)./(c)).^2)))'</span>);
0096 
0097 
0098 <span class="comment">% FITTING</span>
0099 <span class="comment">% ========================================================================</span>
0100 warning off
0101 
0102 ysize = size(yP,2);
0103 
0104 <span class="comment">% Progress bar - all of this is needed to put the progress bar in the</span>
0105 <span class="comment">% middle of the PowerSat window and not the centre of the desktop.</span>
0106 set(gcf, <span class="string">'Units'</span> , <span class="string">'pixels'</span>);
0107 a = waitbar(0,sprintf(<span class="string">'Fitting 1st derivative spectrum %1d of %1d'</span>,0,ysize));
0108 
0109 PS_position = get(handles.figure1,<span class="string">'OuterPosition'</span>);
0110 b = get(a,<span class="string">'OuterPosition'</span>);
0111 set(a,<span class="string">'OuterPosition'</span>,[PS_position(1)+200 PS_position(2)+200 b(3) b(4)]);
0112 
0113 <span class="keyword">for</span> k = 1: ysize
0114     
0115     waitbar(k/ysize,a,sprintf(<span class="string">'Fitting 1st derivative spectrum %1d of %1d'</span>,k,ysize));
0116     
0117     <span class="comment">% Setup fit start point</span>
0118     
0119     <span class="comment">% Again this would be quicker computationally to set outside the for</span>
0120     <span class="comment">% loop but this gives more chance of the fitting not working.</span>
0121     amp    = (max(yP(:,k))  -min(yP(:,k))); 
0122     centre = (max(xP(:))    +min(xP(:)))./2;
0123     width  = ((max(xP(:))   -min(xP(:)))./10).^2;
0124     
0125     options             = fitoptions(f);
0126     options.StartPoint  = [amp centre width];
0127     options.Lower       = [0    0       0];
0128     options.Upper       = [Inf  Inf     Inf];
0129     options.MaxFunEvals = 1200;
0130     options.MaxIter     = 800;
0131     f = setoptions(f, options);
0132     
0133     <span class="comment">% Do the fit</span>
0134     SIGFit = fit(xP,yP(:,k),f);
0135     
0136     <span class="comment">% Get data from the fit</span>
0137     SIGCoeff{k}  = coeffvalues(SIGFit);
0138     vars.(Exp).FitGaussianDeriv.First.y(:,k) = feval(SIGFit,x); 
0139     
0140 <span class="keyword">end</span>
0141 
0142 close(a)
0143 warning on
0144 
0145 
0146 <span class="comment">% POST FITTING</span>
0147 <span class="comment">% ========================================================================</span>
0148 
0149 <span class="comment">% Save fittings to variables</span>
0150 vars.(Exp).FitGaussianDeriv.First.Coeff       = SIGCoeff;
0151 
0152 <span class="comment">% Create fitting curves</span>
0153 vars.(Exp).FitGaussianDeriv.First.x   = xP;
0154 
0155 <span class="comment">% 2nd Dev Gaussian</span>
0156 <span class="comment">% ========================================================================</span>
0157 
0158 vars.(Exp).FitGaussianDeriv.Second.x   = xP;
0159 
0160 <span class="comment">% Setup progress bar again</span>
0161 a = waitbar(0,sprintf(<span class="string">'Calculating 2nd derivative spectrum %1d of %1d'</span>,0,ysize));
0162 
0163 PS_position = get(handles.figure1,<span class="string">'OuterPosition'</span>);
0164 b = get(a,<span class="string">'OuterPosition'</span>);
0165 set(a,<span class="string">'OuterPosition'</span>,[PS_position(1)+200 PS_position(2)+200 b(3) b(4)]);
0166 
0167 <span class="keyword">for</span> k = 1: ysize
0168     
0169     waitbar(k/ysize,a,sprintf(<span class="string">'Calculating 2nd derivative spectrum %1d of %1d'</span>,k,ysize));
0170     
0171     <span class="comment">% Create fitting curves</span>
0172     
0173     vars.(Exp).FitGaussianDeriv.Second.y(:,k)   = <span class="keyword">...</span>
0174         ((SIGCoeff{k}(1)) ./ ((SIGCoeff{k}(3)).^2)).*<span class="keyword">...</span>
0175         ((((xP - SIGCoeff{k}(2)) ./ SIGCoeff{k}(3)).^2)-1).*<span class="keyword">...</span>
0176         (exp(-0.5.*(((xP - SIGCoeff{k}(2)) ./ SIGCoeff{k}(3)).^2)));
0177         
0178     
0179     <span class="comment">% Now we have the coefficients for the fit we can put them into the 2nd</span>
0180     <span class="comment">% deriv. equation and find the x values where y = 0</span>
0181     
0182     <span class="comment">% Set the function (using this general equation, where a=amp, b=centre</span>
0183     <span class="comment">% c=peak width)</span>
0184     <span class="comment">% fun = @(x)(((a1) ./ ((c1).^2)).*((((x - b1) ./ c1).^2)-1).*(exp(-0.5.*(((x - b1) ./ c1).^2))));</span>
0185     
0186     <span class="comment">% Note: this is quite slow, as we are defining the function on each</span>
0187     <span class="comment">% loop, it would be much quicker to simply state this as a subfunction</span>
0188     <span class="comment">% and call it with the same parameters for each fit for each data set.</span>
0189     <span class="comment">% Whilst this would not be a problem for good quality data I cannot</span>
0190     <span class="comment">% guarantee the quality of data being put into the program, thus I have</span>
0191     <span class="comment">% chosen to sacrifice time and fit each spectrum from using it's own</span>
0192     <span class="comment">% coefficients.</span>
0193     
0194     fun = @(xP)<span class="keyword">...</span>
0195         ((SIGCoeff{k}(1)) ./ ((SIGCoeff{k}(3)).^2)).*<span class="keyword">...</span>
0196         ((((xP - SIGCoeff{k}(2)) ./ SIGCoeff{k}(3)).^2)-1).*<span class="keyword">...</span>
0197         (exp(-0.5.*(((xP - SIGCoeff{k}(2)) ./ SIGCoeff{k}(3)).^2)));
0198 
0199     
0200      <span class="comment">% sprintf equation with CoEffs</span>
0201      <span class="comment">% fzero (fun) or fsolve(inline())</span>
0202     
0203     vars.(Exp).FitGaussianDeriv.Second.y0_Max(k) = fzero(fun,[SIGCoeff{k}(2)-(window/2) SIGCoeff{k}(2)]);
0204     vars.(Exp).FitGaussianDeriv.Second.y0_Min(k) = fzero(fun,[SIGCoeff{k}(2) SIGCoeff{k}(2)+(window/2)]);
0205     
0206 <span class="keyword">end</span>
0207 
0208 close(a)
0209 
0210 <span class="comment">% Now that we have the x positions where y = 0 (y0_Max &amp; y0_Min) we need to</span>
0211 <span class="comment">% finally calculate the y value at those positions.</span>
0212 <span class="comment">%</span>
0213 <span class="comment">% Strictly speaking the 1st derivative peak and trough could be used, but</span>
0214 <span class="comment">% this is not guaranteed to be as exact.</span>
0215 <span class="comment">%</span>
0216 <span class="comment">% Finally use the first deriv. equation with x = y0_Max &amp; y0_Min</span>
0217 
0218 <span class="keyword">for</span> k = 1:ysize
0219     vars.(Exp).FitGaussianDeriv.PeakInt(k) = <span class="keyword">...</span>
0220         (-SIGCoeff{k}(1)).*<span class="keyword">...</span>
0221         ((vars.(Exp).FitGaussianDeriv.Second.y0_Max(k)-SIGCoeff{k}(2))./<span class="keyword">...</span>
0222         ((SIGCoeff{k}(3)).^2)).*<span class="keyword">...</span>
0223         (exp(-0.5.*<span class="keyword">...</span>
0224         (((vars.(Exp).FitGaussianDeriv.Second.y0_Max(k)-SIGCoeff{k}(2))./<span class="keyword">...</span>
0225         (SIGCoeff{k}(3))).^2)));
0226     
0227     vars.(Exp).FitGaussianDeriv.TroughInt(k) = <span class="keyword">...</span>
0228         (-SIGCoeff{k}(1)).*<span class="keyword">...</span>
0229         ((vars.(Exp).FitGaussianDeriv.Second.y0_Min(k)-SIGCoeff{k}(2))./<span class="keyword">...</span>
0230         ((SIGCoeff{k}(3)).^2)).*<span class="keyword">...</span>
0231         (exp(-0.5.*<span class="keyword">...</span>
0232         (((vars.(Exp).FitGaussianDeriv.Second.y0_Min(k)-SIGCoeff{k}(2))./<span class="keyword">...</span>
0233         (SIGCoeff{k}(3))).^2)));
0234 <span class="keyword">end</span>
0235</pre></div>
<hr><address>Generated on Thu 25-Oct-2012 18:03:26 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>